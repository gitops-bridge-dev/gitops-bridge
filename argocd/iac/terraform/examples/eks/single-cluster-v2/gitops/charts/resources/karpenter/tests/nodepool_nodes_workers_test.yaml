suite: test nodepool - nodes-workers
templates:
  - nodepool.yaml
values:
  - values.yaml

tests:
  - it: Verify nodes-workers metadata
    documentIndex: 3
    asserts:
      - isKind:
          of: NodePool
      - equal:
          path: metadata.name
          value: nodes-workers-arm64
      - equal:
          path: spec.template.metadata.labels.cluster
          value: eks-dev
      - equal:
          path: spec.template.metadata.labels.nodegroup
          value: nodes-workers
      - isNull:
          path: spec.template.metadata.labels.testlabel1
      - equal:
          path: spec.template.metadata.annotations.testannotation1
          value: annotation1
      - equal:
          path: spec.template.metadata.annotations.testannotation2
          value: annotation2
      - equal:
          path: spec.template.spec.nodeClassRef.name
          value: nodes-workers-arm64
      - equal:
          path: spec.template.spec.startupTaints[0].key
          value: testtaint1
      - equal:
          path: spec.template.spec.startupTaints[0].value
          value: taint1
      - equal:
          path: spec.template.spec.startupTaints[0].effect
          value: NoSchedule
      - equal:
          path: spec.template.spec.startupTaints[1].key
          value: testtaint2
      - equal:
          path: spec.template.spec.startupTaints[1].value
          value: taint2
      - equal:
          path: spec.template.spec.startupTaints[1].effect
          value: NoSchedule
      - equal:
          path: spec.template.spec.taints[0].key
          value: dedicated
      - equal:
          path: spec.template.spec.taints[0].value
          value: nodes_workers
      - equal:
          path: spec.template.spec.taints[0].effect
          value: NoSchedule

  - it: Verify nodes-workers requirements
    documentIndex: 3
    asserts:
      - equal:
          path: spec.template.spec.requirements[0].key
          value: "karpenter.k8s.aws/instance-category"
      - notContains:
          path: spec.template.spec.requirements[0].values
          content: m
      - equal:
          path: spec.template.spec.requirements[0].values[0]
          value: t
      - equal:
          path: spec.template.spec.requirements[0].values[1]
          value: x
      - equal:
          path: spec.template.spec.requirements[1].key
          value: "karpenter.k8s.aws/instance-cpu"
      - equal:
          path: spec.template.spec.requirements[1].values[0]
          value: "2"
      - equal:
          path: spec.template.spec.requirements[1].values[1]
          value: "6"
      - equal:
          path: spec.template.spec.requirements[2].key
          value: "karpenter.k8s.aws/instance-generation"
      - equal:
          path: spec.template.spec.requirements[2].operator
          value: "Gt"
      - equal:
          path: spec.template.spec.requirements[2].values[0]
          value: "4"
      - equal:
          path: spec.template.spec.requirements[3].key
          value: "topology.kubernetes.io/zone"
      - equal:
          path: spec.template.spec.requirements[3].values[0]
          value: "eu-west-1g"
      - equal:
          path: spec.template.spec.requirements[4].key
          value: "kubernetes.io/arch"
      - equal:
          path: spec.template.spec.requirements[4].values[0]
          value: "arm64"
      - equal:
          path: spec.template.spec.requirements[5].key
          value: "karpenter.sh/capacity-type"
      - equal:
          path: spec.template.spec.requirements[5].values[0]
          value: "on-demand"
      - equal:
          path: spec.template.spec.requirements[6].key
          value: "kubernetes.io/os"
      - equal:
          path: spec.template.spec.requirements[6].values[0]
          value: "linux"
      - equal:
          path: spec.template.spec.requirements[7].key
          value: "karpenter.k8s.aws/instance-family"
      - equal:
          path: spec.template.spec.requirements[7].operator
          value: "NotIn"
      - equal:
          path: spec.template.spec.requirements[7].values[0]
          value: "m6a"
      - equal:
          path: spec.template.spec.requirements[8].key
          value: "karpenter.k8s.aws/instance-size"
      - equal:
          path: spec.template.spec.requirements[8].operator
          value: NotIn
      - equal:
          path: spec.template.spec.requirements[8].values[0]
          value: metal
      - equal:
          path: spec.template.spec.requirements[9].key
          value: "capacity-spread"
      - equal:
          path: spec.template.spec.requirements[9].values[0]
          value: "1"
      - equal:
          path: spec.template.spec.requirements[9].values[4]
          value: "5"
      # additional requirements
      - equal:
          path: spec.template.spec.requirements[10].key
          value: "karpenter.k8s.aws/instance-local-nvme"
      - equal:
          path: spec.template.spec.requirements[10].operator
          value: "Exists"
      - equal:
          path: spec.template.spec.requirements[11].key
          value: "karpenter.k8s.aws/other"
      - equal:
          path: spec.template.spec.requirements[11].operator
          value: "In"
      - equal:
          path: spec.template.spec.requirements[11].values[1]
          value: "value2"


  - it: Verify nodes-workers kubelet
    documentIndex: 3
    asserts:
      - equal:
          path: spec.template.spec.kubelet.systemReserved.cpu
          value: 750m
      - equal:
          path: spec.template.spec.kubelet.kubeReserved.ephemeral-storage
          value: 4Gi
      - equal:
          path: spec.template.spec.kubelet.clusterDNS[0]
          value: "1.1.1.1"
      - equal:
          path: spec.template.spec.kubelet.clusterDNS[1]
          value: "2.2.2.2"

  - it: Verify nodes-workers Options
    documentIndex: 3
    asserts:
      - equal:
          path: spec.disruption.expireAfter
          value: 720h
      - equal:
          path: spec.disruption.consolidationPolicy
          value: WhenEmpty
      - equal:
          path: spec.disruption.consolidateAfter
          value: 10m
      - equal:
          path: spec.disruption.budgets[0].nodes
          value: "5"
      - equal:
          path: spec.disruption.budgets[1].nodes
          value: "0"
      - equal:
          path: spec.disruption.budgets[1].schedule
          value: "@daily"
      - equal:
          path: spec.disruption.budgets[1].duration
          value: "10m"
      - equal:
          path: spec.limits.cpu
          value: 100
      - equal:
          path: spec.limits.memory
          value: "384Gi"
      - equal:
          path: spec.weight
          value: 3
